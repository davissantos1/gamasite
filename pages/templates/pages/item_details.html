<!DOCTYPE html>
<html lang="pt-br">
{% load static %}
{% include '_head.html' %}
<body>
    {% include '_header.html' %}

    <!-- Seção de Detalhes do Item -->
    <div class="container mt-5">
        <!-- Título -->
        <div class="text-center">
            <h1 class="display-4">Detalhes do Item</h1>
            <p class="lead">{{ item.nome }}</p>
        </div>

        <!-- Imagens e Informações -->
        <div class="row mt-4">
            <p class="lead">{{ images.imagem.url }}</p>
            
            <!-- Carrossel de Imagens -->
            <div class="col-lg-6">
                <div id="itemImagesCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        {% if item.thumbnail %}
                            <div class="carousel-item active">
                                <img src="{{ item.thumbnail.url }}" class="d-block w-100 rounded shadow" alt="Imagem principal do item">
                            </div>
                        {% else %}
                            <div class="carousel-item active">
                                <img src="{% static 'images/default_item.jpg' %}" class="d-block w-100 rounded shadow" alt="Imagem padrão">
                            </div>
                        {% endif %}
                        
                        {% for imagem in images %}
                        
                            <div class="carousel-item">
                                <img src="{{ imagem.imagem.url }}" class="d-block w-100 rounded shadow" alt="Imagem adicional do item">
                            </div>
                        {% empty %}
                            <div class="carousel-item active">
                                <img src="{% static 'images/default_item.jpg' %}" class="d-block w-100 rounded shadow" alt="Imagem padrão">
                            </div>
                        {% endfor %}
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#itemImagesCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Anterior</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#itemImagesCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Próxima</span>
                    </button>
                </div>
            </div>

            <!-- Detalhes do Item -->
            <div class="col-lg-6">
                <div class="card p-4 shadow-sm">
                    <h3>Informações</h3>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Descrição:</strong> {{ item.descricao }}</li>
                        <li class="list-group-item"><strong>Valor Inicial:</strong> R$ {{ item.valor_inicial|floatformat:2 }}</li>
                        <li class="list-group-item"><strong>Valor Avaliado:</strong> R$ {{ item.valor_avaliado|floatformat:2 }}</li>
                        <li class="list-group-item"><strong>Status do Lote:</strong> {{ item.status_lote }}</li>
                        <li class="list-group-item"><strong>Status de Pagamento:</strong> {{ item.status_pagamento }}</li>
                    </ul>
                    <div class="mt-4">
                        <h4>Tempo Restante</h4>
                        <div id="countdown" class="fs-5 text-danger"></div>
                    </div>
                    <div class="mt-4">
                        <p><strong>Lance Atual:</strong> R$ {{ item.bids.first.amount|default:"Nenhum lance ainda"|floatformat:2 }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulário de Lance -->
        <div class="mt-5">
            <h4>Dar um Lance</h4>
            <form method="POST" action="#">
                {% csrf_token %}
                <div class="input-group">
                    <input type="number" step="0.01" min="{{ item.valor_inicial }}" class="form-control" name="valor_lance" placeholder="Insira o valor do lance" required>
                    <button class="btn btn-primary" type="submit">Enviar Lance</button>
                </div>
            </form>
            {% if item.bids.exists %}
                <h5 class="mt-4">Lances Atuais</h5>
                <ul class="list-group">
                    {% for bid in item.bids.all %}
                        {% if bid.is_valid %}
                            <li class="list-group-item">
                                {{ bid.user }} - R$ {{ bid.amount|floatformat:2 }} - {{ bid.timestamp|date:"d/m/Y H:i" }}
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            {% else %}
                <p>Nenhum lance disponível para este item.</p>
            {% endif %}
        </div>

        <!-- Detalhes Específicos -->
        <div class="mt-5">
            {% if item_type == 'Vehicle' %}
                <h4>Detalhes do Veículo</h4>
                <ul class="list-group">
                    <li class="list-group-item"><strong>Marca:</strong> {{ item.marca }}</li>
                    <li class="list-group-item"><strong>Modelo:</strong> {{ item.modelo }}</li>
                    <li class="list-group-item"><strong>Ano de Fabricação:</strong> {{ item.fabricacao }}</li>
                    <li class="list-group-item"><strong>Categoria:</strong> {{ item.categoria_veiculo }}</li>
                    <li class="list-group-item"><strong>FIPE:</strong> R$ {{ item.fipe|floatformat:2 }}</li>
                    <li class="list-group-item"><strong>Versão:</strong> {{ item.versao }}</li>
                    <li class="list-group-item"><strong>Condicionamento:</strong> {{ item.condicao_funcionamento }}</li>
                    <li class="list-group-item"><strong>Combustível:</strong> {{ item.combustivel }}</li>
                </ul>
            {% elif item_type == 'RealEstate' %}
                <h4>Detalhes do Imóvel</h4>
                <ul class="list-group">
                    <li class="list-group-item"><strong>Localização:</strong> {{ item.localizacao }}</li>
                    <li class="list-group-item"><strong>Estado do Imóvel:</strong> {{ item.estado_imovel }}</li>
                    <li class="list-group-item"><strong>Quartos:</strong> {{ item.quartos }}</li>
                    <li class="list-group-item"><strong>Metragem:</strong> {{ item.metragem }} m²</li>
                </ul>
            {% elif item_type == 'Rural' %}
                <h4>Detalhes do Item Rural</h4>
                <ul class="list-group">
                    <li class="list-group-item"><strong>Origem:</strong> {{ item.origem }}</li>
                </ul>
            {% elif item_type == 'OtherGoods' %}
                <h4>Detalhes de Outros Bens</h4>
                <ul class="list-group">
                    <li class="list-group-item"><strong>Informações adicionais:</strong> Nenhum detalhe específico disponível.</li>
                </ul>
            {% else %}
                <h4>Outras Informações</h4>
                <ul class="list-group">
                    <li class="list-group-item"><strong>Detalhes adicionais:</strong> Nenhum detalhe específico disponível.</li>
                </ul>
            {% endif %}
        </div>
    </div>

    {% include '_footer.html' %}

    <!-- Script do Contador -->
    <script>
        const countdownElement = document.getElementById('countdown');
        const targetDate = new Date("{{ item.leilao.date_time|date:'Y-m-d\\TH:i:sP' }}"); // Inclui fuso horário no formato ISO 8601

        function updateCountdown() {
            const now = new Date();
            const diff = targetDate - now;

            if (diff <= 0) {
                countdownElement.textContent = "Leilão iniciado!";
                clearInterval(countdownInterval); // Para o intervalo após início
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            countdownElement.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }

        const countdownInterval = setInterval(updateCountdown, 1000); // Chama a função a cada 1 segundo
        updateCountdown(); // Atualiza imediatamente ao carregar
    </script>
</body>
</html>
